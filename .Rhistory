for (i in seq_len(ncol(data))){
if(inherits(data[,i],c("numeric","integer")) == FALSE)
stop("Data are neither numeric nor integer")
}
#Creating covariance matrix for Minimum Covariance Determinant
# by default, use the "best" method = exhaustive method
# output <- fastMCD(data, h=0)
output <- covFastMCD(data[index_good,], alpha = 0.6, m=10, l=1, delta = 0.05)
Qualitycontrol.Mcd <- function(object,h = .5,alpha = .01){
x <- get.nearest.dataset(object)
pred_outliers <- rep(TRUE, nrow(x))
out_na <- is.na(rowSums(x))
dis <- rep(NA, nrow(x))
if(any(out_na))pred_outliers[out_na] <- FALSE
x <- prcomp_irlba(x[pred_outliers,], n = 20, center = TRUE, scale. = TRUE)$x[,1:5]
out <- outliers_mcdEst(x,h,alpha)
dis[pred_outliers] <- out$dist_from_center
pred_outliers[pred_outliers][out$outliers_pos] <- FALSE
return(data.frame(quality=pred_outliers, Distance = dis))
}
outliers_mcdEst <- function(data,
h = .75, # fraction of data we wanna keep
# to compute the MCD (between 0 and 1)
alpha = .01){
for (i in seq_len(ncol(data))){
if(inherits(data[,i],c("numeric","integer")) == FALSE)
stop("Data are neither numeric nor integer")
}
#Creating covariance matrix for Minimum Covariance Determinant
# by default, use the "best" method = exhaustive method
# output <- fastMCD(data, h=0)
output <- covFastMCD(data, alpha = 0.6, m=10, l=1, delta = 0.05)
cutoff <- (qchisq(p = 1-alpha, df = ncol(data)))
#Distances from centroid for each matrix
dist <- mahalanobis(data,output$center,output$cov, tol=-1) # distance
#Detecting outliers
names_outliers <- which(dist > cutoff)
coordinates <- data.frame(
matrix(NA, nrow = length(names_outliers), ncol = ncol(data))
)
for (k in seq_len(ncol(data))){
coordinates[,k] <- data[,k][dist > cutoff]
}
# Return results in list()
invisible(
list(MaxDist = cutoff,
center = output$center,
outliers_pos = names_outliers,
outliers_val=coordinates,
dist_from_center = dist)
)
}
qc_MCD <- Qualitycontrol.Mcd(data_mammalian, h=0.5, alpha=0.01)
?h.alpha.n
library(robustbase)
qc_MCD <- Qualitycontrol.Mcd(data_mammalian, h=0.5, alpha=0.01)
conf_mat <- confusionMatrix(factor(qc_MCD$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('MCD', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
conf_mat <- confusionMatrix(factor(qc_icod$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('ICOD', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
qc_results <- readRDS("D:\\Scientific research\\RamEx\\文章\\Figures\\True\\outliers_5_true_datasets.rds")
recall_each <- lapply(qc_results,function(df)apply(df,2, function(x)cal_acc(as.numeric(factor(x)),df$true %>% gsub('good|Good',2,.) %>% gsub('Bad',1,.))[6]))
cal_acc <- function(x,y){
conf_mat <- confusionMatrix(factor(x, levels = c(1,2)), factor(y), positive = "1")
return(conf_mat$byClass)
}
recall_each <- lapply(qc_results,function(df)apply(df,2, function(x)cal_acc(as.numeric(factor(x)),df$true %>% gsub('good|Good',2,.) %>% gsub('Bad',1,.))[6]))
recall_each <- recall_each %>% map(~ .x %>% as.data.frame %>% rownames_to_column('ENSEMBL') )
?map
library(purr)
library(purrr)
recall_each <- recall_each %>% map(~ .x %>% as.data.frame %>% rownames_to_column('ENSEMBL') )
?rownames_to_column
library(tibble)
recall_each <- recall_each %>% map(~ .x %>% as.data.frame %>% rownames_to_column('ENSEMBL') )
recall_each <- map_df(recall_each, rbind, .id = "source")
colnames(recall_each) <- c('level','Methods','recall') # precision, recall
cols <- c("#BF5B17", "#B15928", "#FDB462", "#1B9E77", "#DECBE4", "#FFED6F", "#A6CEE3", "#E7298A", "#FBB4AE", "#999999", "#FFFF33", "#A6761D", "#66C2A5")  # sample(col_vector, 13)
cols <- c('#6F6F6F','#547BB4','#629C35','6C61AF','#C0321A')
recall_each$Methods %<>% factor(., levels = c('T2','SNR','mcd','dis','jump_4'))
library(magrittr)
recall_each$Methods %<>% factor(., levels = c('T2','SNR','mcd','dis','jump_4'))
p <- ggplot(recall_each[recall_each$Methods %in% c('T2', 'SNR', 'mcd', 'dis', 'jump_4'),], aes(Methods,recall,group=Methods, color=Methods, fill=Methods, label=round(recall,2)))+ #
geom_bar(stat="summary",fun=mean, position="dodge",linewidth=0.5,color="black", width=0.95) +
stat_summary(fun = mean,
geom = "errorbar",
fun.max = function(x) mean(x) + sd(x),
fun.min = function(x) mean(x) - sd(x),position = position_dodge (.9),width=0.15,size=0.9)+
# geom_text(size=5,vjust=-0.5,position = position_dodge(0.95))+
# geom_path(aes(color = Methods), linewidth=1.5) +
theme_bw() +
scale_fill_manual(values = cols)+
scale_color_manual(values = cols)+
# ylim(c(0.5,1)) +
# coord_cartesian(ylim = c(0.5,1))+
theme(panel.grid = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 15, angle = 0),
# legend.position = 'None',
strip.background = element_rect(fill='white'))
p
p <- ggplot(recall_each[recall_each$Methods %in% c('T2', 'SNR', 'mcd', 'dis', 'jump'),], aes(level,recall,group=Methods, color=Methods, fill=Methods, label=round(recall,2)))+ #
geom_bar(stat="summary",fun=mean, position="dodge",linewidth=0.5,color="black", width=0.95) +
stat_summary(fun = mean,
geom = "errorbar",
fun.max = function(x) mean(x) + sd(x),
fun.min = function(x) mean(x) - sd(x),position = position_dodge (.9),width=0.15,size=0.9)+
# geom_text(size=5,vjust=-0.5,position = position_dodge(0.95))+
# geom_path(aes(color = Methods), linewidth=1.5) +
theme_bw() +
scale_fill_manual(values = cols)+
scale_color_manual(values = cols)+
# ylim(c(0.5,1)) +
# coord_cartesian(ylim = c(0.5,1))+
theme(panel.grid = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 15, angle = 0),
# legend.position = 'None',
strip.background = element_rect(fill='white'))
p
qc_results <- readRDS("D:\\Scientific research\\RamEx\\文章\\Figures\\True\\outliers_5_true_datasets.rds")
View(qc_results)
qc_results$mamm <- list(T2 = qc_T2,
SNR = qc_SNR,
mcd = qc_MCD,
dis = qc_Dis,
jump = qc_icod,
true = data_mammalian$quality)
recall_each <- lapply(qc_results,function(df)apply(df,2, function(x)cal_acc(as.numeric(factor(x)),df$true %>% gsub('good|Good|TRUE',2,.) %>% gsub('Bad|FALSE',1,.))[7]))
colnames(recall_each) <- c('level','Methods','recall') # precision, recall
qc_results <- readRDS("D:\\Scientific research\\RamEx\\文章\\Figures\\True\\outliers_5_true_datasets.rds")
qc_results$mamm <- list(T2 = qc_T2$quality,
SNR = qc_SNR$quality,
mcd = qc_MCD$quality,
dis = qc_Dis$quality,
jump = qc_icod$quality,
true = data_mammalian$quality)
recall_each <- lapply(qc_results,function(df)apply(df,2, function(x)cal_acc(as.numeric(factor(x)),df$true %>% gsub('good|Good|TRUE',2,.) %>% gsub('Bad|FALSE',1,.))[7]))
qc_results <- readRDS("D:\\Scientific research\\RamEx\\文章\\Figures\\True\\outliers_5_true_datasets.rds")
qc_results$mamm <- list(T2 = qc_T2$quality %>% as.character(),
SNR = qc_SNR$quality %>% as.character(),
mcd = qc_MCD$quality %>% as.character(),
dis = qc_Dis$quality %>% as.character(),
jump = qc_icod$quality %>% as.character(),
true = data_mammalian$quality %>% as.character())
recall_each <- lapply(qc_results,function(df)apply(df,2, function(x)cal_acc(as.numeric(factor(x)),df$true %>% gsub('good|Good|TRUE',2,.) %>% gsub('Bad|FALSE',1,.))[7]))
qc_results <- readRDS("D:\\Scientific research\\RamEx\\文章\\Figures\\True\\outliers_5_true_datasets.rds")
qc_results$mamm <- data.frame(T2 = qc_T2$quality %>% as.character(),
SNR = qc_SNR$quality %>% as.character(),
mcd = qc_MCD$quality %>% as.character(),
dis = qc_Dis$quality %>% as.character(),
jump = qc_icod$quality %>% as.character(),
true = data_mammalian$quality %>% as.character())
recall_each <- lapply(qc_results,function(df)apply(df,2, function(x)cal_acc(as.numeric(factor(x)),df$true %>% gsub('good|Good|TRUE',2,.) %>% gsub('Bad|FALSE',1,.))[7]))
recall_each <- recall_each %>% map(~ .x %>% as.data.frame %>% rownames_to_column('ENSEMBL') )
recall_each <- map_df(recall_each, rbind, .id = "source")
colnames(recall_each) <- c('level','Methods','recall') # precision, recall
cols <- c("#BF5B17", "#B15928", "#FDB462", "#1B9E77", "#DECBE4", "#FFED6F", "#A6CEE3", "#E7298A", "#FBB4AE", "#999999", "#FFFF33", "#A6761D", "#66C2A5")  # sample(col_vector, 13)
cols <- c('#6F6F6F','#547BB4','#629C35','6C61AF','#C0321A')
recall_each$Methods %<>% factor(., levels = c('T2','SNR','mcd','dis','jump'))
p <- ggplot(recall_each[recall_each$Methods %in% c('T2', 'SNR', 'mcd', 'dis', 'jump'),], aes(level,recall,group=Methods, color=Methods, fill=Methods, label=round(recall,2)))+ #
geom_bar(stat="summary",fun=mean, position="dodge",linewidth=0.5,color="black", width=0.95) +
stat_summary(fun = mean,
geom = "errorbar",
fun.max = function(x) mean(x) + sd(x),
fun.min = function(x) mean(x) - sd(x),position = position_dodge (.9),width=0.15,size=0.9)+
# geom_text(size=5,vjust=-0.5,position = position_dodge(0.95))+
# geom_path(aes(color = Methods), linewidth=1.5) +
theme_bw() +
scale_fill_manual(values = cols)+
scale_color_manual(values = cols)+
# ylim(c(0.5,1)) +
# coord_cartesian(ylim = c(0.5,1))+
theme(panel.grid = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 15, angle = 0),
# legend.position = 'None',
strip.background = element_rect(fill='white'))
p
p <- ggplot(recall_each[recall_each$Methods %in% c('T2', 'SNR', 'mcd', 'dis', 'jump'),], aes(level,recall,group=Methods, color=Methods, fill=Methods, label=round(recall,2)))+ #
geom_bar(stat="summary",fun=mean, position="dodge",linewidth=0.5,color="black", width=0.95) +
stat_summary(fun = mean,
geom = "errorbar",
fun.max = function(x) mean(x) + sd(x),
fun.min = function(x) mean(x) - sd(x),position = position_dodge (.9),width=0.15,size=0.9)+
geom_text(size=5,vjust=-0.5,position = position_dodge(0.95))+
# geom_path(aes(color = Methods), linewidth=1.5) +
theme_bw() +
scale_fill_manual(values = cols)+
scale_color_manual(values = cols)+
# ylim(c(0.5,1)) +
# coord_cartesian(ylim = c(0.5,1))+
theme(panel.grid = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 15, angle = 0),
# legend.position = 'None',
strip.background = element_rect(fill='white'))
p
lapply(qc_results, function(x)cat(table(x$true)/nrow(x)))
lapply(qc_results, function(x)table(x$true)/nrow(x))
recall_each$level %<>% factor(., levels = c('HP','TB','AS','ysj','mamm','spores'))
p <- ggplot(recall_each[recall_each$Methods %in% c('T2', 'SNR', 'mcd', 'dis', 'jump'),], aes(level,recall,group=Methods, color=Methods, fill=Methods, label=round(recall,2)))+ #
geom_bar(stat="summary",fun=mean, position="dodge",linewidth=0.5,color="black", width=0.95) +
stat_summary(fun = mean,
geom = "errorbar",
fun.max = function(x) mean(x) + sd(x),
fun.min = function(x) mean(x) - sd(x),position = position_dodge (.9),width=0.15,size=0.9)+
geom_text(size=5,vjust=-0.5,position = position_dodge(0.95))+
# geom_path(aes(color = Methods), linewidth=1.5) +
theme_bw() +
scale_fill_manual(values = cols)+
scale_color_manual(values = cols)+
# ylim(c(0.5,1)) +
# coord_cartesian(ylim = c(0.5,1))+
theme(panel.grid = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 15, angle = 0),
# legend.position = 'None',
strip.background = element_rect(fill='white'))
p
p <- ggplot(acc_each, aes(level,F1,group=Methods, color=Methods, fill=Methods, label=round(F1,2)))+ #
geom_bar(stat="summary",fun=mean, position="dodge",linewidth=0.5,color="black", width=0.95) +
geom_text(size=5,vjust=-0.5,position = position_dodge(0.95))+
# geom_path(aes(color = Methods), linewidth=1.5) +
theme_bw() +
scale_fill_manual(values = cols)+
scale_color_manual(values = cols)+
# ylim(c(0.5,1)) +
# coord_cartesian(ylim = c(0.5,1))+
theme(panel.grid = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 15, angle = 0),
# legend.position = 'None',
strip.background = element_rect(fill='white'))
p
p <- ggplot(recall_each, aes(level,F1,group=Methods, color=Methods, fill=Methods, label=round(F1,2)))+ #
geom_bar(stat="summary",fun=mean, position="dodge",linewidth=0.5,color="black", width=0.95) +
geom_text(size=5,vjust=-0.5,position = position_dodge(0.95))+
# geom_path(aes(color = Methods), linewidth=1.5) +
theme_bw() +
scale_fill_manual(values = cols)+
scale_color_manual(values = cols)+
# ylim(c(0.5,1)) +
# coord_cartesian(ylim = c(0.5,1))+
theme(panel.grid = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 15, angle = 0),
# legend.position = 'None',
strip.background = element_rect(fill='white'))
p
p <- ggplot(recall_each, aes(level,recall,group=Methods, color=Methods, fill=Methods, label=round(recall,2)))+ #
geom_bar(stat="summary",fun=mean, position="dodge",linewidth=0.5,color="black", width=0.95) +
geom_text(size=5,vjust=-0.5,position = position_dodge(0.95))+
# geom_path(aes(color = Methods), linewidth=1.5) +
theme_bw() +
scale_fill_manual(values = cols)+
scale_color_manual(values = cols)+
# ylim(c(0.5,1)) +
# coord_cartesian(ylim = c(0.5,1))+
theme(panel.grid = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 15, angle = 0),
# legend.position = 'None',
strip.background = element_rect(fill='white'))
p
qc_results <- readRDS("D:\\Scientific research\\RamEx\\文章\\Figures\\True\\outliers_5_true_datasets.rds")
qc_results$mamm <- data.frame(T2 = qc_T2$quality %>% as.character(),
SNR = qc_SNR$quality %>% as.character(),
mcd = qc_MCD$quality %>% as.character(),
dis = qc_Dis$quality %>% as.character(),
jump = qc_icod$quality %>% as.character(),
true = data_mammalian$quality %>% as.character())
lapply(qc_results, function(x)table(x$true)/nrow(x))
recall_each <- lapply(qc_results,function(df)apply(df[,-6],2, function(x)cal_acc(as.numeric(factor(x)),df$true %>% gsub('good|Good|TRUE',2,.) %>% gsub('Bad|FALSE',1,.))[7]))
recall_each <- recall_each %>% map(~ .x %>% as.data.frame %>% rownames_to_column('ENSEMBL') )
recall_each <- map_df(recall_each, rbind, .id = "source")
colnames(recall_each) <- c('level','Methods','recall') # precision, recall
cols <- c('#6F6F6F','#547BB4','#629C35','6C61AF','#C0321A')
recall_each$Methods %<>% factor(., levels = c('T2','SNR','mcd','dis','jump'))
recall_each$level %<>% factor(., levels = c('HP','TB','AS','ysj','mamm','spores'))
p <- ggplot(recall_each, aes(level,recall,group=Methods, color=Methods, fill=Methods, label=round(recall,2)))+ #
geom_bar(stat="summary",fun=mean, position="dodge",linewidth=0.5,color="black", width=0.95) +
geom_text(size=5,vjust=-0.5,position = position_dodge(0.95))+
# geom_path(aes(color = Methods), linewidth=1.5) +
theme_bw() +
scale_fill_manual(values = cols)+
scale_color_manual(values = cols)+
# ylim(c(0.5,1)) +
# coord_cartesian(ylim = c(0.5,1))+
theme(panel.grid = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 15, angle = 0),
# legend.position = 'None',
strip.background = element_rect(fill='white'))
p
setwd('D:\\Scientific research\\RamEx\\文章\\Revision')
eoffice::topptx(figure = p, filename = "Revision.pptx", width = 8, height = 5.5, append = T, title = 'F1')
conf_mat <- confusionMatrix(factor(qc_T2$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('T2', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
p
eoffice::topptx(figure = p, filename = "Revision.pptx", width = 8, height = 5.5, append = T, title = 'F1')
recall_each <- lapply(qc_results,function(df)apply(df[,-6],2, function(x)cal_acc(as.numeric(factor(x)),df$true %>% gsub('good|Good|TRUE',2,.) %>% gsub('Bad|FALSE',1,.))[6]))
recall_each <- recall_each %>% map(~ .x %>% as.data.frame %>% rownames_to_column('ENSEMBL') )
recall_each <- map_df(recall_each, rbind, .id = "source")
colnames(recall_each) <- c('level','Methods','recall') # precision, recall
cols <- c('#6F6F6F','#547BB4','#629C35','6C61AF','#C0321A')
recall_each$Methods %<>% factor(., levels = c('T2','SNR','mcd','dis','jump'))
recall_each$level %<>% factor(., levels = c('HP','TB','AS','ysj','mamm','spores'))
p <- ggplot(recall_each, aes(level,recall,group=Methods, color=Methods, fill=Methods, label=round(recall,2)))+ #
geom_bar(stat="summary",fun=mean, position="dodge",linewidth=0.5,color="black", width=0.95) +
geom_text(size=5,vjust=-0.5,position = position_dodge(0.95))+
# geom_path(aes(color = Methods), linewidth=1.5) +
theme_bw() +
scale_fill_manual(values = cols)+
scale_color_manual(values = cols)+
# ylim(c(0.5,1)) +
# coord_cartesian(ylim = c(0.5,1))+
theme(panel.grid = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 15, angle = 0),
# legend.position = 'None',
strip.background = element_rect(fill='white'))
p
eoffice::topptx(figure = p, filename = "Revision.pptx", width = 8, height = 5.5, append = T, title = 'Recall')
recall_each <- lapply(qc_results,function(df)apply(df[,-6],2, function(x)cal_acc(as.numeric(factor(x)),df$true %>% gsub('good|Good|TRUE',2,.) %>% gsub('Bad|FALSE',1,.))[5]))
recall_each <- recall_each %>% map(~ .x %>% as.data.frame %>% rownames_to_column('ENSEMBL') )
recall_each <- map_df(recall_each, rbind, .id = "source")
colnames(recall_each) <- c('level','Methods','recall') # precision, recall
cols <- c('#6F6F6F','#547BB4','#629C35','6C61AF','#C0321A')
recall_each$Methods %<>% factor(., levels = c('T2','SNR','mcd','dis','jump'))
recall_each$level %<>% factor(., levels = c('HP','TB','AS','ysj','mamm','spores'))
p <- ggplot(recall_each, aes(level,recall,group=Methods, color=Methods, fill=Methods, label=round(recall,2)))+ #
geom_bar(stat="summary",fun=mean, position="dodge",linewidth=0.5,color="black", width=0.95) +
geom_text(size=5,vjust=-0.5,position = position_dodge(0.95))+
# geom_path(aes(color = Methods), linewidth=1.5) +
theme_bw() +
scale_fill_manual(values = cols)+
scale_color_manual(values = cols)+
# ylim(c(0.5,1)) +
# coord_cartesian(ylim = c(0.5,1))+
theme(panel.grid = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 15, angle = 0),
# legend.position = 'None',
strip.background = element_rect(fill='white'))
p
eoffice::topptx(figure = p, filename = "Revision.pptx", width = 8, height = 5.5, append = T, title = 'Precision')
saveRDS(qc_results, 'outliers_8_true_datasets.rds')
data_mammalian <- read.spec('D:\\Scientific research\\RamEx\\文章\\Revision\\哺乳动物细胞\\人阴道上皮细胞-拭子')
files <- list.files('D:\\Scientific research\\RamEx\\文章\\Revision\\哺乳动物细胞\\人阴道上皮细胞-拭子-质控后', include.dirs = T, recursive = T)
data_mammalian@meta.data$quality <- basename(data_mammalian$filenames) %in% basename(files)
table(data_mammalian$quality)
data_mammalian %<>% Preprocessing.Smooth.Sg %>% Preprocessing.Baseline.Polyfit %>% Preprocessing.Normalize(.,'ch')
qc_icod <- Qualitycontrol.ICOD(data_mammalian, var_tol = 1)
qc_SNR <- Qualitycontrol.Snr(data_mammalian)
qc_Dis <- Qualitycontrol.Dis(data_mammalian)
qc_MCD <- Qualitycontrol.Mcd(data_mammalian)
qc_T2 <- Qualitycontrol.T2(data_mammalian)
table(data_mammalian$quality, qc_icod$quality)
basename(data_mammalian$filenames)[data_mammalian$quality & !qc_icod$quality]
conf_mat <- confusionMatrix(factor(qc_icod$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('ICOD', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
conf_mat <- confusionMatrix(factor(qc_SNR$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('SNR', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
conf_mat <- confusionMatrix(factor(qc_Dis$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('Dis', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
conf_mat <- confusionMatrix(factor(qc_MCD$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('MCD', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
conf_mat <- confusionMatrix(factor(qc_T2$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('T2', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
?Qualitycontrol.ICOD
aa <- list.files('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\质控后\\C3-原液')
aa <- read.spec('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\质控后\\C3-原液')
for(i in which(rowMeans(aa$raw.data) < 0)){
file.remove(aa$filenames[i])}
data_mammalian <- read.spec('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\原始数据')
files <- list.files('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\质控后', include.dirs = T, recursive = T)
library(stringr)
index <- str_split_i(basename(data_mammalian$filenames),'_',8) %>% as.numeric
table(index)
basename(data_mammalian$filenames)[2]
index <- str_split_i(basename(data_mammalian$filenames),'_|.',8) %>% as.numeric
table(index < 1000)
index
index <- str_split_i(basename(data_mammalian$filenames),'_|.',5) %>% as.numeric
index <- str_split_i(basename(data_mammalian$filenames),'_',5) %>% as.numeric
index <- str_split_i(basename(data_mammalian$filenames),'_',5)
basename(data_mammalian$filenames)[2]
index <- str_split_i(basename(data_mammalian$filenames) %>% gsub('.txt','',.),'_',8)
index <- str_split_i(basename(data_mammalian$filenames) %>% gsub('.txt','',.),'_',8) %>% as.numeric()
table(index < 1000)
data_mammalian <- data_mammalian[index < 1001,]
table(data_mammalian$quality)
data_mammalian@meta.data$quality <- basename(data_mammalian$filenames) %in% basename(files)
table(data_mammalian$quality)
data_mammalian %<>% Preprocessing.Smooth.Sg %>% Preprocessing.Baseline.Polyfit %>% Preprocessing.Normalize(.,'ch')
qc_icod <- Qualitycontrol.ICOD(data_mammalian, var_tol = 1)
table(data_mammalian$quality, qc_icod$quality)
basename(data_mammalian$filenames)[data_mammalian$quality & !qc_icod$quality]
table(data_mammalian$quality, qc_icod$quality)
aa <- read.spec('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\质控后\\C3-原液')
for(i in which(rowMeans(aa$raw.data) < 20)){
file.remove(aa$filenames[i])}
data_mammalian <- read.spec('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\原始数据')
files <- list.files('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\质控后', include.dirs = T, recursive = T)
data_mammalian@meta.data$quality <- basename(data_mammalian$filenames) %in% basename(files)
table(data_mammalian$quality)
data_mammalian %<>% Preprocessing.Smooth.Sg %>% Preprocessing.Baseline.Polyfit %>% Preprocessing.Normalize(.,'ch')
qc_icod <- Qualitycontrol.ICOD(data_mammalian, var_tol = 1)
table(data_mammalian$quality, qc_icod$quality)
data_mammalian <- read.spec('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\原始数据')
files <- list.files('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\质控后', include.dirs = T, recursive = T)
data_mammalian@meta.data$quality <- basename(data_mammalian$filenames) %in% basename(files)
table(data_mammalian$quality, qc_icod$quality)
data_mammalian <- data_mammalian[index < 1001,]
table(data_mammalian$quality, qc_icod$quality)
qc_icod <- Qualitycontrol.ICOD(data_mammalian, var_tol = 1)
table(data_mammalian$quality, qc_icod$quality)
qc_icod <- Qualitycontrol.ICOD(data_mammalian, var_tol = 0.4)
table(data_mammalian$quality, qc_icod$quality)
qc_icod <- Qualitycontrol.ICOD(data_mammalian, var_tol = 0.5)
table(data_mammalian$quality, qc_icod$quality)
qc_icod <- Qualitycontrol.ICOD(data_mammalian, var_tol = 0.3)
table(data_mammalian$quality, qc_icod$quality)
data_mammalian %<>% Preprocessing.Smooth.Sg %>% Preprocessing.Baseline.Polyfit %>% Preprocessing.Normalize(.,'area')
qc_icod <- Qualitycontrol.ICOD(data_mammalian, var_tol = 0.3)
table(data_mammalian$quality, qc_icod$quality)
qc_icod <- Qualitycontrol.ICOD(data_mammalian, var_tol = 0.5)
table(data_mammalian$quality, qc_icod$quality)
conf_mat <- confusionMatrix(factor(qc_icod$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('ICOD', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
data_mammalian <- read.spec('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\原始数据')
# ----------------------- 哺乳动物细胞mock 样品 ----------------------------
library(RamEx)
library(magrittr)
data_mammalian <- read.spec('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\原始数据')
files <- list.files('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\质控后', include.dirs = T, recursive = T)
data_mammalian@meta.data$quality <- basename(data_mammalian$filenames) %in% basename(files)
data_mammalian %<>% Preprocessing.Smooth.Sg %>% Preprocessing.Baseline.Polyfit %>% Preprocessing.Normalize(.,'ch')
qc_icod <- Qualitycontrol.ICOD(data_mammalian, var_tol = 1)
table(data_mammalian$quality, qc_icod$quality)
files <- list.files('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\质控后-2', include.dirs = T, recursive = T)
data_mammalian@meta.data$quality <- basename(data_mammalian$filenames) %in% basename(files)
table(data_mammalian$quality, qc_icod$quality)
data_mammalian@meta.data$quality <- basename(data_mammalian$filenames) %in% basename(files)
table(data_mammalian$quality)
table(data_mammalian$quality, qc_icod$quality)
files <- list.files('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\质控后-2', include.dirs = T, recursive = T)
data_mammalian@meta.data$quality <- basename(data_mammalian$filenames) %in% basename(files)
table(data_mammalian$quality, qc_icod$quality)
basename(data_mammalian$filenames)[!data_mammalian$quality & qc_icod$quality]
data_mammalian <- read.spec('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\原始数据')
files <- list.files('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\质控后-2', include.dirs = T, recursive = T)
data_mammalian@meta.data$quality <- basename(data_mammalian$filenames) %in% basename(files)
table(data_mammalian$quality)
data_mammalian %<>% Preprocessing.Smooth.Sg %>% Preprocessing.Baseline.Polyfit %>% Preprocessing.Normalize(.,'ch')
qc_icod <- Qualitycontrol.ICOD(data_mammalian, var_tol = 1)
qc_SNR <- Qualitycontrol.Snr(data_mammalian)
qc_Dis <- Qualitycontrol.Dis(data_mammalian)
qc_MCD <- Qualitycontrol.Mcd(data_mammalian)
qc_T2 <- Qualitycontrol.T2(data_mammalian)
table(data_mammalian$quality, qc_icod$quality)
library(caret)
conf_mat <- confusionMatrix(factor(qc_icod$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('ICOD', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
conf_mat <- confusionMatrix(factor(qc_SNR$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('SNR', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
conf_mat <- confusionMatrix(factor(qc_Dis$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('Dis', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
conf_mat <- confusionMatrix(factor(qc_MCD$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('MCD', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
conf_mat <- confusionMatrix(factor(qc_T2$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('T2', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
data_mammalian <- read.spec('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\原始数据')
files <- list.files('D:\\Scientific research\\RamEx\\文章\\Revision\\海洋环境样本\\质控后-2', include.dirs = T, recursive = T)
data_mammalian@meta.data$quality <- basename(data_mammalian$filenames) %in% basename(files)
table(data_mammalian$quality)
data_mammalian %<>% Preprocessing.Smooth.Sg %>% Preprocessing.Baseline.Polyfit %>% Preprocessing.Normalize(.,'area')
qc_icod <- Qualitycontrol.ICOD(data_mammalian, var_tol = 1)
qc_SNR <- Qualitycontrol.Snr(data_mammalian)
qc_Dis <- Qualitycontrol.Dis(data_mammalian)
qc_MCD <- Qualitycontrol.Mcd(data_mammalian)
qc_T2 <- Qualitycontrol.T2(data_mammalian)
table(data_mammalian$quality, qc_icod$quality)
basename(data_mammalian$filenames)[data_mammalian$quality & !qc_icod$quality]
library(caret)
conf_mat <- confusionMatrix(factor(qc_icod$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('ICOD', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
conf_mat <- confusionMatrix(factor(qc_SNR$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('SNR', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
conf_mat <- confusionMatrix(factor(qc_Dis$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('Dis', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
conf_mat <- confusionMatrix(factor(qc_MCD$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('MCD', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
conf_mat <- confusionMatrix(factor(qc_T2$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), factor(data_mammalian$quality %>% gsub(TRUE,2,.) %>% gsub(FALSE, 1,.)), positive = '1')
cat('T2', '\t', ': Precision ', conf_mat$byClass[5], '\tRecall ',conf_mat$byClass[6], '\tF1 ',conf_mat$byClass[7],'\n')
table(data_mammalian$quality, qc_T2$quality)
detach("package:RamEx", unload = TRUE)
remove.packages('RamEx')
setwd('D:\\Scientific research\\RamEx\\RamanEx代码\\RamEx-2025.03.28\\RamEx')
library(devtools)
document()
document()
build()
build()
install.packages("D:/Scientific research/RamEx/RamanEx代码/RamEx-2025.03.28/RamEx_1.0.0.tar.gz", repos = NULL, type = "source")
files <- list.files('D:\\Scientific research\\合作项目\\数据库\\公开的数据\\cleaned_neuron', include.dirs = T, recursive = T)
length(files)
files <- list.files('D:\\Scientific research\\RamEx\\文章\\Revision\\哺乳动物细胞\\神经元', include.dirs = T, recursive = T)
length(files)
4772-2883
1889/4772
